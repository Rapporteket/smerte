---
params:
  title: 'Tid til død etter utskrivelse'
  author: 'Rapporteket'
  hospitalName: 'Ukjent sykehus'
  reshId: 'locallyDefined'
  userRole: 'MyRole'
  userFullName: 'Ukjent bruker'
  startDate: !r lubridate::today() - lubridate::years(1)
  endDate: !r lubridate::today() - lubridate::weeks(1)
  year: '2016'
  tableFormat: 'html'
  registryName: 'rapbase'
  shinySession: list()
title: '`r paste(params$title, params$hospitalName, " i perioden fra ", params$startDate, " til ", params$endDate)`'
author: '`r params$author`'
date: '`r format(Sys.time(), "%d\\. %B, %Y")`'
reglogo: '`r system.file("www/logoSmerte.png", package = "smerte")`'
regtext: '`r readLines(system.file("registryShortDescription.txt", package = "smerte"))`'
registryName: Smerteregisteret
userFullName: '`r params$userFullName`'
---
```{r set options and load packages, include = FALSE}
knitr::opts_chunk$set(echo=FALSE)
options(knitr.table.format = params$tableFormat)
options(tinytex.verbose = TRUE)
```

```{r get data, include=FALSE}

if (rapbase::isRapContext()) {
  fulldat <- smerte::getRegDataTimetodeath(
    registryName = params$registryName,
    reshId = params$reshId,
    userRole = params$userRole,
    startDate = params$startDate,
    endDate = params$endDate,
    session = params$shinySession
  )
} else {
  
  #Dataimport: skal hente lokale data for hvert sykehus (tar vekk sti, og erstatter med lokal fil)
  
  #AlleVarNum
  path <- read.csv(file = "H:/path.csv", header = FALSE, sep = ";")
  path <- as.data.frame(lapply(path, as.character), stringsAsFactors=FALSE)
  path <- path$V1
  dat <- read.csv(file = path, header = TRUE, sep = ";")
  
  #Diagnosefil numerisk
  pathd <- read.csv(file = "H:/pathdiag.csv", header = FALSE, sep = ";")
  pathd <- as.data.frame(lapply(pathd, as.character), stringsAsFactors=FALSE)
  pathd <- pathd$V1
  diagnum <- read.csv(file = pathd, header = TRUE, sep = ";")
  
  #Diagnosefil
  pathdt <- read.csv(file = "H:/pathdiagtekst.csv", header = FALSE, sep = ";", encoding = "UTF-8")
  pathdt <- as.data.frame(lapply(pathdt, as.character), stringsAsFactors=FALSE)
  pathdt <- pathdt$V1
  diag <- read.csv(file = pathdt, header = TRUE, sep = ";", encoding = "UTF-8")
  
  #Joiner diagnose numerisk og diagnosetekst
  diagfull = diagnum %>% left_join(diag, by = c("ForlopsID", "HovedDato", "SmerteDiagID"))
  #Joiner så AlleVarNum med diagnose_full
  fulldat = left_join(dat, diagfull, by = "ForlopsID")
  
}

#Funksjon som skal evaluere om dataframe er tom eller ikke
dataPresent <- TRUE
if(dim(fulldat)[1] < 1) {
  dataPresent <- FALSE
}
```



```{r noData, eval=!dataPresent, results='asis'}
cat('# Upps...\nI den valgte tidsperioden er det ikke nok data til å gi 
    ut resultater.')
knitr::knit_exit()

```
