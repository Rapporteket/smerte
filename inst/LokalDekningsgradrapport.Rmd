---
params:
  title: 'Dekningsgrad ved'
  author: 'Rapporteket'
  hospitalName: 'Ukjent sykehus'
  reshId: 'locallyDefined'
  userRole: 'MyRole'
  startDate: '2017-01-01'
  endDate: '2017-12-31'
  year: '2016'
  tableFormat: 'html'
  registryName: 'rapbase'
  shinySession: list()
title: '`r paste(params$title, params$hospitalName, " i perioden fra ", params$startDate, " til ", params$endDate)`'
author: '`r params$author`'
date: '`r format(Sys.time(), "%d\\. %B, %Y")`'
header-includes:
- \usepackage[english, norsk]{babel}
- \usepackage{booktabs}
- \usepackage{rotating}
---
```{r set options and load packages, include = FALSE}
knitr::opts_chunk$set(echo=FALSE)
options(knitr.table.format = params$tableFormat)
options(tinytex.verbose = TRUE)

# Pakker
library(tidyverse)
library(stringr)
library(zoo)
#library(dplyr)
library(magrittr)
library(lubridate)
library(smerte)
library(knitr)
```

```{r get data, warning = FALSE, message=TRUE}

if (rapbase::isRapContext()) {
  dat <- getRegDataRapportDekningsgrad(registryName = params$registryName,
                                       reshId = params$reshId,
                                       userRole = params$userRole,
                                       startDate = params$startDate,
                                       endDate = params$endDate,
                                       session = params$shinySession)
} else {
  #Dataimport: skal hente lokale data for hvert sykehus (tar vekk sti, og erstatter med lokal filB)
  path <- read.csv(file = "H:/path.csv", header = FALSE, sep = ";")
  path <- as.data.frame(lapply(path, as.character), stringsAsFactors=FALSE)
  path <- path$V1
  dat <- read.csv(file = path, header = TRUE, sep = ";")
  
  # avdpath <- read.csv(file = "H:/avdelingpath.csv", header = FALSE, sep = ";")
  # avdpath <- as.data.frame(lapply(avdpath, as.character), stringsAsFactors=FALSE)
  # avdpath <- avdpath$V1
  # avd <- read.csv(file = avdpath, header = TRUE, sep = ";", encoding = "UTF-8")
  # #Endrer navn til å matche rapporteket
  # avd <- avd %>% rename(DEPARTMENT_ID = AvdID, DEPARTMENT_NAME = AvdNavn, DEPARTMENT_SHORTNAME = AvdNavnKort)
  # 
  # #Samler datasettene vha InnlAvd i allevarnum og departmentID i avdelingsoversikt
  # dat <- merge(x = dat, y = avd, by.x = c("InnlAvd"), by.y = c("DEPARTMENT_ID"))

  #Må kunne laste inn data for de ulike årene
  #aar <- params$year
  #dat = dat %>% filter(year(date(StartdatoTO)) == aar) #year
}


```

## Dekningsgrad

Dekningsgraden beregnes lokalt for hvert sykehus. Den viser andelen pasienter som har samtykket til å være med i registeret av alle som oppfyller inklusjonskriteriene. 

```{r inkludert, warning = FALSE, message=FALSE, results='asis'}

if (dim(dat)[1] < 1) {
  message <- "I den valgte tidsperioden er det ikke nok data til å angi dekningsgrad."
} else {
  antInk <- sum(dat$InklKritOppf == 1)
  sam <- dat$SkrSamtykke
  # NA/NULL to be counted as none-consent
  sam[is.na(sam)] <- 0
  antSam <- sum(sam == 1)
  if (antInk < 1) {
    message <- "I den valgte tidsperioden er det ikke nok data til å angi dekningsgrad."
  } else {
    dekning <- antSam / antInk
    message <- paste0("Dekningsgraden for ", params$hospitalName,
                      " i den valgte tidsperioden er __",
                      round(dekning, digits = 2), "__. Totalt antall er __",
                      antInk, "__ hvorav __", antSam, "__ samtykker er gitt.")
  }
  
}

cat(paste("\n", message))

```

### Tallgrunnlag og utvalg

```{r caveat, warning=FALSE, message=FALSE, results='asis'}

changedConsentInd <- dat$SkrSamtykke > 0 & dat$SkrSamtykke < 1
changedInclInd <- dat$InklKritOppf > 0 & dat$InklKritOppf < 1

message <- paste0("I perioden er det registrert totalt __",
                  sum(dat$AntForlop), "__ forløp fordelt på __",
                  length(dat$SkrSamtykke), "__ personer. Av disse er det __",
                  length(dat$SkrSamtykke[changedConsentInd]),
                  "__ personer som i løpet av samme periode har endret sitt samtykke. ",
                  "Disse er ikke talt med i beregningen over.")

cat(paste("\n", message))

message <- paste0("I perioden finnes det __",
                  length(dat$InklKritOppf[changedInclInd]),
                  "__ personer som har endret status for inklusjon.",
                  " Disse er heller ikke tatt med i beregningen over.")

cat(paste("\n", message))


