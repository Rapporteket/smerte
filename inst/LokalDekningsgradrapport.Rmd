---
params:
  title: 'Dekningsgrad ved'
  author: 'Rapporteket'
  hospitalName: 'Ukjent sykehus'
  reshId: 'locallyDefined'
  userRole: 'MyRole'
  startDate: '2017-01-01'
  endDate: '2017-12-31'
  year: '2016'
  tableFormat: 'html'
  registryName: 'rapbase'
  shinySession: list()
title: '`r paste(params$title, params$hospitalName, " i perioden fra ", params$startDate, " til ", params$endDate)`'
author: '`r params$author`'
date: '`r format(Sys.time(), "%d\\. %B, %Y")`'
header-includes:
- \usepackage[english, norsk]{babel}
- \usepackage{booktabs}
- \usepackage{rotating}
---
```{r set options and load packages, include = FALSE}
knitr::opts_chunk$set(echo=FALSE)
options(knitr.table.format = params$tableFormat)
options(tinytex.verbose = TRUE)

# Pakker
library(tidyverse)
library(stringr)
library(zoo)
#library(dplyr)
library(magrittr)
library(lubridate)
library(smerte)
library(knitr)
```

```{r get data, warning = FALSE, message=TRUE}

if (rapbase::isRapContext()) {
  dat <- getRegDataRapportDekningsgrad(registryName = params$registryName,
                                       reshId = params$reshId,
                                       userRole = params$userRole,
                                       startDate = params$startDate,
                                       endDate = params$endDate)
} else {
  #Dataimport: skal hente lokale data for hvert sykehus (tar vekk sti, og erstatter med lokal filB)
  path <- read.csv(file = "H:/path.csv", header = FALSE, sep = ";")
  path <- as.data.frame(lapply(path, as.character), stringsAsFactors=FALSE)
  path <- path$V1
  dat <- read.csv(file = path, header = TRUE, sep = ";")
  
  # avdpath <- read.csv(file = "H:/avdelingpath.csv", header = FALSE, sep = ";")
  # avdpath <- as.data.frame(lapply(avdpath, as.character), stringsAsFactors=FALSE)
  # avdpath <- avdpath$V1
  # avd <- read.csv(file = avdpath, header = TRUE, sep = ";", encoding = "UTF-8")
  # #Endrer navn til å matche rapporteket
  # avd <- avd %>% rename(DEPARTMENT_ID = AvdID, DEPARTMENT_NAME = AvdNavn, DEPARTMENT_SHORTNAME = AvdNavnKort)
  # 
  # #Samler datasettene vha InnlAvd i allevarnum og departmentID i avdelingsoversikt
  # dat <- merge(x = dat, y = avd, by.x = c("InnlAvd"), by.y = c("DEPARTMENT_ID"))

  #Må kunne laste inn data for de ulike årene
  #aar <- params$year
  #dat = dat %>% filter(year(date(StartdatoTO)) == aar) #year
}


```

## Dekningsgrad

Dekningsgraden beregnes lokalt for hvert sykehus. Den viser andelen pasienter som har samtykket til å være med i registeret av alle som oppfyller inklusjonskriteriene. 
```{r inkludert, warning = FALSE, message=FALSE, include = FALSE, results='asis'}
###Her klargjøres data for oversikt over dekningsgraden

# Setter tom først for å kunne sjekke etter tilstrekkelig antall pasienter
dekning <- NA 

#Skrsamtykke er 0 (nei), 1 (ja) eller null. Finner ikke at null er de som ikke er inkluderbar => må endre disse. Endrer til 0, da det ikke gjør en forskjell i utregningen vår (er kun interessert i å summere 1-ere. Nevner er basert på annen variabel).
dat$SkrSamtykke <- as.numeric(levels(dat$SkrSamtykke)[dat$SkrSamtykke])

#Hvor mange er inkluderbar (må være minst 1, ellers deler vi på 0 senere)
antInkl <- sum(dat$InklKritOppf == 1)

#Dersom minst 1 oppfyller kriteriene setter vi dekning fra NA til samtykke/inkluderbar. Ellers skriver vi setningen under.
if(antInkl >= 1){
  dekning <- sum(dat$SkrSamtykke == 1, na.rm = TRUE) / sum(dat$InklKritOppf == 1)
}else{dekning <- as.character("ikke tilgjengelig, ettersom ingen pasienter oppfylte inklusjonskriteriene i den valgte tidsperioden.")}


```
Dekningsgraden for `r params$hospitalName` i den valgte tidsperioden er `r round(dekning, digits = 2)`.
