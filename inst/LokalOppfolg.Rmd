---
params:
  title: 'Oppfølging ved smerteklinikk'
  author: 'Rapporteket'
  hospitalName: 'Ukjent sykehus'
  reshId: 'locallyDefined'
  userRole: 'MyRole'
  userFullName: 'Ukjent bruker'
  startDate: '2017-01-01'
  endDate: '2017-12-31'
  year: '2016'
  tableFormat: 'html'
  registryName: 'rapbase'
  shinySession: list()
title: '`r paste(params$title, params$hospitalName, " i perioden fra ", params$startDate, " til ", params$endDate)`'
author: '`r params$author`'
date: '`r format(Sys.time(), "%d\\. %B, %Y")`'
reglogo: '`r system.file("www/logoSmerte.png", package = "smerte")`'
regtext: '`r readLines(system.file("registryShortDescription.txt", package = "smerte"))`'
registryName: Smerteregisteret
userFullName: '`r params$userFullName`'
---
```{r set options and load packages, include = FALSE}
knitr::opts_chunk$set(echo=FALSE)
options(knitr.table.format = params$tableFormat)
options(tinytex.verbose = TRUE)
```

```{r get data, include=FALSE}

if (rapbase::isRapContext()) {
  dat <- smerte::getRegDataRapportOppfolg(
    registryName = params$registryName,
    reshId = params$reshId,
    userRole = params$userRole,
    startDate = params$startDate,
    endDate = params$endDate,
    session = params$shinySession
  )
} else {
  #Dataimport: skal hente lokale data for hvert sykehus (tar vekk sti, og erstatter med lokal filB)
  path <- read.csv(file = "H:/path.csv", header = FALSE, sep = ";")
  path <- as.data.frame(lapply(path, as.character), stringsAsFactors=FALSE)
  path <- path$V1
  dat <- read.csv(file = path, header = TRUE, sep = ";")
}


```

# Anbefalt videre oppfølging ved smerteklinikk

Denne tabellen viser en oversikt over om pasientene blir anbefalt videre oppfølging ved smerteklinikk og hvordan de er fordelt mellom
avdelingene på sykehuset i løpet av hele tidsperioden.

```{r avdelingstabell, warning = TRUE, message=TRUE, results='asis'}
###Her klargjøres data for avdelingsoversikt
#Antall/n er pas tils
sum_tilsyn_avdeling <- tilsyn_full %>%
  dplyr::group_by(tilsynstype, DEPARTMENT_SHORTNAME) %>% 
  dplyr::summarise(antall = sum(antall), .groups = "drop_last") %>% 
  tidyr::spread(tilsynstype, antall) %>%
  dplyr::rowwise() %>% 
  dplyr::mutate(behandlertilsyn = sum(Fysioterapeut, Lege, Psykolog, Sosionom,
                                      Sykepleier))

antall_pas_avdeling <- tilsyn_full %>%
  dplyr::distinct(ForlopsID, .keep_all = TRUE) %>%
  dplyr::count(DEPARTMENT_SHORTNAME, name = "n") 

sum_tilsyn_avdeling <- cbind(sum_tilsyn_avdeling, n = antall_pas_avdeling$n) 

# Finne summen av hver tilsynstype
total_tilsyn_avdeling <- colSums(sum_tilsyn_avdeling[, -1])

#Få inn navnet på den nye "avdelingen"
sum_tilsyn_avdeling$DEPARTMENT_SHORTNAME <-
  as.character(sum_tilsyn_avdeling$DEPARTMENT_SHORTNAME)

#Ta vekk de som ikke har hatt pasienter (f.eks andre sykehus sine avdelinger)
sum_tilsyn_avdeling <-
  sum_tilsyn_avdeling[!is.na(sum_tilsyn_avdeling$DEPARTMENT_SHORTNAME), ]

#Fra de med flest til færrest pasienter
sum_tilsyn_avdeling <- dplyr::arrange(sum_tilsyn_avdeling, desc(n))
#Få inn navnet på den nye raden

#Legge på totalrad nederst
sum_tilsyn_avdeling <- sum_tilsyn_avdeling %>%
  dplyr::bind_rows(total_tilsyn_avdeling)

#Legge til navn
sum_tilsyn_avdeling[nrow(sum_tilsyn_avdeling), 1] <- "Total"

# Bytte på rekkefølgen slik at behandlertilsyn kommer før pasienttilsyn
sum_tilsyn_avdeling = sum_tilsyn_avdeling[,c(1,2,3,4,5,6,8,7,9)]
sum_tilsyn_avdeling = sum_tilsyn_avdeling %>%
  dplyr::mutate(DEPARTMENT_SHORTNAME =
                  stringr::str_replace_all(DEPARTMENT_SHORTNAME, "\n", " "))

rapbase::mst(
  tab = sum_tilsyn_avdeling,
  col_names = c("Avdeling", "Fysio", "Lege", "Psyk", "Sosio", "Sykepl",
                "Beh tilsyn", "Pas tilsyn", "Ant pas"),
  type = params$tableFormat,
  cap = paste("Antall tilsyn per avdeling.",
              "Vises i synkende rekkefølge fra flest pasienter til", 
              "færrest."),
  digs = 0,
  align = c("l", "r", "r", "r", "r", "r", "r", "r", "r"))

```
